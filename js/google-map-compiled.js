(function(b){var c=decodeURIComponent,d=b.deparam=function(a,j){var g={};b.each(a.replace(/\+/g," ").split("&"),function(a,o){var n;var i=o.split("="),e=c(i[0]);if(e){var i=c(i[1]||""),f=e.split("]["),k=f.length-1,l=0,m=g;0<=f[0].indexOf("[")&&/\]$/.test(f[k])?(f[k]=f[k].replace(/\]$/,""),f=f.shift().split("[").concat(f),k++):k=0;b.isFunction(j)?i=j(e,i):j&&(i=d.reviver(e,i));if(k)for(;l<=k;l++)e=""!==f[l]?f[l]:m.length,l<k?(n=m[e]=m[e]||(isNaN(f[l+1])?{}:[]),m=n):m[e]=i;else b.isArray(g[e])?g[e].push(i):
g[e]=e in g?[g[e],i]:i}});return g};d.reviver=function(a,b){var d={"true":!0,"false":!1,"null":null,undefined:void 0};return+b+""===b?+b:b in d?d[b]:b}})(jQuery);
function changeHash(){document.location.hash=""==polyString?$.param({city:currentCity,year:yearSlider,mariguana:mjVisible,poppy:poppyVisible,meth:methVisible,cocaine:cocaineVisible,zoom:currentZoom,homtype:typeOfHomicide,clat:centerLat,clong:centerLong}):$.param({city:currentCity,year:yearSlider,mariguana:mjVisible,poppy:poppyVisible,meth:methVisible,cocaine:cocaineVisible,zoom:currentZoom,homtype:typeOfHomicide,clat:centerLat,clong:centerLong,polygon:polyString})}
var style=[{featureType:"road.highway",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"landscape",elementType:"all",stylers:[{hue:"#00"},{saturation:-100},{lightness:22}]},{featureType:"poi",stylers:[{visibility:"off"}]},{featureType:"water",stylers:[{visibility:"simplified"},{hue:"#000000"},{saturation:-100},{lightness:-30}]},{featureType:"administrative.country",stylers:[{visibility:"simplified"}]},{featureType:"road.arterial",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"road.local",
elementType:"all",stylers:[{visibility:"off"}]},{featureType:"poi",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"transit",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"administrative.province",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"administrative.locality",elementType:"all",stylers:[{visibility:"off"}]}],homrate=[],datehom=[],homtot=[],drhrate=[],drhtot=[],pop=[],commas=pv.Format.number(),parameters,layer,vis,state,showingNames=!1,overlay,crimes=
[],currentCity="All of M\u00e9xico",currentZoom=5,newShape,selectedShape,coords=[],mjlayer,poppylayer,lablayer,mjpathslayer,poppypathslayer,methpathslayer,mj_paths=824024,poppy_paths=2310300,meth_paths=2308189,homicide_month=2330644,dots,visChart,yearSlider=2010,changed=!1,drh_layer=2243315,mjVisible=!0,poppyVisible=!1,methVisible=!1,cocaineVisible=!1,typeOfHomicide="INEGI",scaleFactor=0.5,centerLat=23.61796278994952,centerLong=-95.02734375,violenceData,baseURLCartodb="http://diegovalle.cartodb.com/api/v1/sql/?q=",
map,coords=[],polyString="",myPolygon=null,lastModePoly=!1,hom=[8.9679,9.2364,9.4695,7.9538,9.6681,9.2762,8.5966,8.9098,8.589,8.959,8.972,9.3178,8.826,8.988,9.6414,9.7678,9.3462,10.157,9.3255,9.0877,9.589,9.3855,9.3411,10.271,10.112,8.5871,9.616,9.4025,10.327,9.5731,9.5851,10.372,10.293,9.3632,10.114,9.868,6.7315,5.6536,8.7664,8.5788,10.392,8.4491,8.2624,8.475,7.835,8.5451,7.796,8.5927,9.7734,9.2235,11.072,10.346,12.551,13.348,12.852,14.041,12.89,15.975,16.536,16.551,14.923,16.026,15.423,14.496,15.953,
17.981,17.497,19.152,19.595,18.379,17.423,19.845,null,null,null,null,null,null,null,null,null,null,null,null],hom2=[772,796,817,687,836,803,745,773,746,779,781,812,770,785,843,855,819,891,819,799,844,827,824,907,894,760,852,834,917,851,853,924,918,836,904,883,603,507,787,771,935,761,745,765,708,773,706,779,887,838,1007,942,1144,1218,1174,1284,1180,1464,1517,1520,1372,1475,1421,1337,1473,1662,1619,1774,1817,1706,1619,1846],drh=[null,null,null,null,null,null,null,null,null,null,null,null,null,null,
null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,0.69288,1.6298,1.182,2.963,2.7706,3.4789,2.2205,1.7634,3.3235,2.8994,3.25,2.86,3.0003,3.3717,3.6432,3.8701,3.229,5.5513,5.6111,6.7217,7.7205,6.2593,9.3844,10.693,8.7327,6.3957,8.0512,6.7944,6.9498,6.9099,9.9859,9.1647,9.522,10.008,9.7388,8.9429,11.438,11.598,10.599,13.567,13.381,14.575,15.959,15.942,15.862,12.352,15.605,11.466,12.144],drh2=[62,146,106,266,249,313,200,159,300,262,294,259,272,306,
331,352,294,506,512,614,706,573,860,981,802,588,741,626,641,638,923,848,882,928,904,831,1064,1080,988,1266,1250,1363,1494,1494,1488,1160,1467,1079,1144];
function toggleProvince(){showingNames?(style.push({featureType:"administrative.province",elementType:"all",stylers:[{visibility:"off"}]}),style.push({featureType:"administrative.locality",elementType:"all",stylers:[{visibility:"off"}]})):(style.pop(),style.pop());var b=new google.maps.StyledMapType(style,{map:map,name:"Styled Map"});map.mapTypes.set("map-style",b);map.setMapTypeId("map-style");showingNames=!showingNames}
function getUrlVars(){for(var b=[],c,d=window.location.href.slice(window.location.href.indexOf("#")+1).split("&"),a=0;a<d.length;a++)c=d[a].split("="),b.push(c[0]),b[c[0]]=c[1];return b}
function queryData(){if("DWRH"===typeOfHomicide)var b="SELECT drh, rate, lat, long, name FROM homicides_year_web WHERE year = "+yearSlider+"AND drh > 0 ORDER BY drh DESC",c="drh",d="rate";else b="SELECT hom, homrate, rate, lat, long, name FROM homicides_year_web WHERE year = "+yearSlider+"AND hom > 0 ORDER BY hom DESC",c="hom",d="homrate";$.getJSON(baseURLCartodb+encodeURIComponent(b),function(a){violenceData=a;overlay.crimes.splice(0,overlay.crimes.length);for(var b=0;b<a.rows.length;b++)overlay.crimes.push({lat:a.rows[b].lat,
lon:a.rows[b]["long"],latlon:new google.maps.LatLng(a.rows[b].lat,a.rows[b]["long"]),code:a.rows[b][c],name:a.rows[b].name,rate:a.rows[b][d],hom:a.rows[b].hom,homrate:a.rows[b].homrate});overlay.draw()})}Canvas.prototype=pv.extend(google.maps.OverlayView);function Canvas(b,c){this.crimes=b;this.map=c;this.setMap(c)}Canvas.prototype.onAdd=function(){this.getPanes().overlayLayer.style.zIndex=104;this.canvas=document.createElement("div");this.canvas.setAttribute("class","canvas");this.getPanes().overlayMouseTarget.appendChild(this.canvas)};
mariguana_muns.forEach(function(b){b.borders.forEach(function(b){b.forEach(function(d,a){b[a]=new google.maps.LatLng(d[1],d[0])})})});poppy_muns.forEach(function(b){b.borders.forEach(function(b){b.forEach(function(d,a){b[a]=new google.maps.LatLng(d[1],d[0])})})});
Canvas.prototype.draw=function(){function b(a){return a.x}function c(a){return a.y}var d=this.getProjection(),a=this.canvas,j=100;if("DWRH"===typeOfHomicide&2006>=yearSlider){j=200;overlay.crimes.splice(0,overlay.crimes.length);overlay.crimes.push({latlon:new google.maps.LatLng(23.5,-105.118408)});var g=this.crimes.map(function(a){return d.fromLatLngToDivPixel(a.latlon)}),b=function(a){return a.x},c=function(a){return a.y},b={min:pv.min(g,b)-j,max:pv.max(g,b)+j},c={min:pv.min(g,c)-j,max:pv.max(g,
c)+j};a.style.width=b.max-b.min+"px";a.style.height=c.max-c.min+"px";a.style.left=b.min+"px";a.style.top=c.min+"px";vis=(new pv.Panel).canvas(a).left(-b.min).top(-c.min).add(pv.Panel).data(crimes).add(pv.Label).left(function(a){return d.fromLatLngToDivPixel(a.latlon).x}).top(function(a){return d.fromLatLngToDivPixel(a.latlon).y}).textAlign("center").text("No Data").font("102px sans-serif").textAngle(-5.5)}else{g=this.crimes.map(function(a){return d.fromLatLngToDivPixel(a.latlon)});b={min:pv.min(g,
b)-j,max:pv.max(g,b)+j};c={min:pv.min(g,c)-j,max:pv.max(g,c)+j};a.style.width=b.max-b.min+"px";a.style.height=c.max-c.min+"px";a.style.left=b.min+"px";a.style.top=c.min+"px";var n=pv.Scale.root(0,1600).range(0,55),o=pv.Scale.linear(1,14,30,45,60,75,90,105,129).range("#F5F5F5","#F5f5f5","#FCBBA1","#FC9272","#FB6A4A","#EF3B2C","#CB181D","#A50F15","#99000d");vis=(new pv.Panel).canvas(a).left(-b.min).top(-c.min);var i=pv.Scale.linear(1,35.02).range(0,0.8),e,f,k,l;vis.add(pv.Panel).data(mariguana_muns).add(pv.Panel).data(function(a){return a.borders}).add(pv.Line).data(function(a){return a}).left(function(a){e=
d.fromLatLngToDivPixel(a);return e.x}).top(function(){return e.y}).fillStyle("rgba(76, 187, 23, 0.5)").lineWidth(1).visible(mjVisible).strokeStyle("black").title(function(a,b,d){return d.name}).antialias(!1).root.add(pv.Panel).data(poppy_muns).add(pv.Panel).data(function(a){return a.borders}).add(pv.Line).data(function(a){return a}).visible(poppyVisible).left(function(a){f=d.fromLatLngToDivPixel(a);return f.x}).top(function(){return f.y}).fillStyle("rgba(156, 138, 165, 0.5)").lineWidth(1).strokeStyle("black").title(function(a,
b,d){return d.name}).antialias(!1).root.add(pv.Panel).data(lab_density).add(pv.Dot).visible(methVisible).left(function(a){k=d.fromLatLngToDivPixel(new google.maps.LatLng(a.y,a.x));return k.x}).top(function(){return k.y}).radius(function(){return 7>currentZoom?3:8<currentZoom?5:7}).fillStyle(function(a){return"rgba(0, 0, 0, "+i(a.z)+")"}).strokeStyle("rgba(0, 0, 0, 0)").root.add(pv.Panel).data(crimes).add(pv.Dot).cursor("pointer").left(function(a){l=d.fromLatLngToDivPixel(a.latlon);return l.x}).top(function(){return l.y}).radius(function(a){return n(a.code)*
scaleFactor}).lineWidth(function(a){return a.name!=currentCity?1:4}).strokeStyle(function(a){return 20>a.code&7>currentZoom?null:a.name!=currentCity?"#444":"black"}).def("active",-1).fillStyle(function(a){return 20>a.code&7>currentZoom?null:o(130<a.rate?130:a.rate).alpha(0.9)}).size(990).event("click",function(a){deleteSelectedShape();old=this;currentCity=a.name;queryHomicideMonth(currentCity);return this.root}).event("mouseover",function(){this.active(this.index);return pv.Behavior.tipsy({gravity:"s",
fade:!0,html:!0})},function(){alert("click call back")}).event("mouseout",function(){return this.active(-1)}).anchor("center").add(pv.Label).title(function(a){return a.name}).textStyle("black").font(function(a){return 70>a.code?0.75*n(70)*scaleFactor+"px sans-serif":0.75*n(a.code)*scaleFactor+"px sans-serif"}).text(function(a,b){if("INEGI"==typeOfHomicide){if(250<b.code&15<b.rate)return b.code}else if(250<b.code&10<b.rate)return b.code;return 7<=currentZoom&&20<b.code?b.code:""})}vis.root.render()};
function switchLayers(b,c){c?b.setMap(null):b.setMap(map)}function showMJ(){switchLayers(mjpathslayer,mjVisible);mjVisible=!mjVisible;changeHash();overlay.draw()}function showPoppy(){switchLayers(poppypathslayer,poppyVisible);poppyVisible=!poppyVisible;changeHash();overlay.draw()}function showMeth(){switchLayers(methpathslayer,methVisible);methVisible=!methVisible;changeHash();overlay.draw()}
function queryHomicideMonth(){if("Polygon"==currentCity)if(null!=newShape){polyString="";for(var b=newShape.getPath().b.concat(newShape.getPath().b[0]),c=0;c<b.length;c++)polyString=polyString+b[c].lng()+" "+b[c].lat(),c<b.length-1&&(polyString+=",");currentCity="Polygon";b="SELECT sum(drh) AS drh, sum(hom) AS hom, ((SUM(drh)/SUM(pop))*100000 * 12) AS drhrate, SUM(hom)/SUM(pop) * 100000 * 12 AS homrate, date, sum(pop) AS pop FROM homicides_web WHERE ST_Intersects(the_geom,  GEOMETRYFROMTEXT('MULTIPOLYGON((("+
polyString+")))', 4326)) GROUP BY date ORDER BY date"}else""!=polyString&&(b="SELECT sum(drh) AS drh, sum(hom) AS hom, ((SUM(drh)/SUM(pop))*100000 * 12) AS drhrate, SUM(hom)/SUM(pop) * 100000 * 12 AS homrate, date, sum(pop) AS pop FROM homicides_web WHERE ST_Intersects(the_geom,  GEOMETRYFROMTEXT('MULTIPOLYGON((("+polyString+")))', 4326)) GROUP BY date ORDER BY date");else b="SELECT drh, hom, drhrate, homrate, date, pop FROM homicides_web WHERE name = '"+currentCity+"' ORDER BY date";$.getJSON(baseURLCartodb+
encodeURIComponent(b),function(b){violenceData=b;homrate=[];datehom=[];homtot=[];drhrate=[];drhtot=[];pop=[];for(var a=0;a<b.rows.length;a++)datehom.push(b.rows[a].date),drhtot.push(b.rows[a].drh),drhrate.push(b.rows[a].drhrate),homtot.push(b.rows[a].hom),homrate.push(b.rows[a].homrate),pop.push(b.rows[a].pop);changeHash();b=function(a,b,c,d,i){var a=eval(a.slice(d,i).join("+")),e=c.slice(1)+"tip",f="#"+e;$(f).tipsy("hide");$(c).html('<a id="'+e+'" href="#" original-title="<table><tr><td>rate:</td><td>'+
Math.round(pv.mean(b.slice(d,i)))+"</td></tr><br/><tr><td>population:</td><td> "+commas(pv.mean(pop.slice(d,i)))+'">'+a+"</td></tr></table></a>");$(f).tipsy({html:!0,gravity:"s"})};b(homtot,homrate,"#h2004",0,12);b(homtot,homrate,"#h2005",12,24);b(homtot,homrate,"#h2006",24,36);b(homtot,homrate,"#h2007",36,48);b(homtot,homrate,"#h2008",48,60);b(homtot,homrate,"#h2009",60,72);b(homtot,homrate,"#h2010",72,84);document.getElementById("n2004").innerHTML="NA";document.getElementById("n2005").innerHTML=
"NA";document.getElementById("n2006").innerHTML="NA";b(drhtot,drhrate,"#n2007",36,48);b(drhtot,drhrate,"#n2008",48,60);b(drhtot,drhrate,"#n2009",60,72);b(drhtot,drhrate,"#n2010",72,84);document.getElementById("city").innerHTML=currentCity;rerenderGraph();null!=vis&&vis.root.render()})}
function getDataYear(b){var c=b.getDataTable().getNumberOfRows();homrate=[];datehom=[];homtot=[];drhrate=[];drhtot=[];for(var d=0;d<c;d++){var a=Number(b.getDataTable().getValue(d,0));72<=d&&(a=null);homrate.push(a);datehom.push(new Date(b.getDataTable().getValue(d,1)));homtot.push(Number(b.getDataTable().getValue(d,2)));drhtot.push(Number(b.getDataTable().getValue(d,3)));a=Number(b.getDataTable().getValue(d,4));isNaN(a)&&(a=null);drhrate.push(a)}changeHash();document.getElementById("h2004").innerHTML=
eval(homtot.slice(0,12).join("+"));document.getElementById("h2005").innerHTML=eval(homtot.slice(12,24).join("+"));document.getElementById("h2006").innerHTML=eval(homtot.slice(24,36).join("+"));document.getElementById("h2007").innerHTML=eval(homtot.slice(36,48).join("+"));document.getElementById("h2008").innerHTML=eval(homtot.slice(48,60).join("+"));document.getElementById("h2009").innerHTML=eval(homtot.slice(60,72).join("+"));document.getElementById("h2010").innerHTML="NA";document.getElementById("n2004").innerHTML=
"NA";document.getElementById("n2005").innerHTML="NA";document.getElementById("n2006").innerHTML="NA";document.getElementById("n2007").innerHTML=eval(drhtot.slice(36,48).join("+"));document.getElementById("n2008").innerHTML=eval(drhtot.slice(48,60).join("+"));document.getElementById("n2009").innerHTML=eval(drhtot.slice(60,72).join("+"));document.getElementById("n2010").innerHTML=eval(drhtot.slice(72,84).join("+"));document.getElementById("city").innerHTML=currentCity;rerenderGraph()}
var drawPolygon=function(b,c){var d=new google.maps.Polygon({paths:c,strokeColor:"#AA2143",strokeOpacity:1,strokeWeight:2,fillColor:"#FF6600",fillOpacity:0.7});d.cartodb_id=b;d.setMap(map);google.maps.event.addListener(d,"click",function(){this.setEditable(!0);setSelection(this)});polys.push(d)};function toPath(b){for(var c=0;c<b.length;c++){var d=b.getAt(c);coords.push(d.lng()+" "+d.lat())}}var clearSelection=function(){selectedShape&&(selectedShape.setEditable(!1),selectedShape=null)};
function deleteSelectedShape(){selectedShape&&selectedShape.setMap(null);polyString="";null!=myPolygon&&myPolygon.setMap(null)}var setSelection=function(b){clearSelection();selectedShape=b;b.setEditable(!1)};
function initialize(){initializeParameters();var b={zoom:Number(currentZoom),minZoom:4,center:new google.maps.LatLng(centerLat,centerLong),mapTypeId:google.maps.MapTypeId.ROADMAP,streetViewControl:!1,panControl:!1};map=new google.maps.Map(document.getElementById("map"),b);b=new google.maps.StyledMapType(style,{map:map,name:"Styled Map"});map.mapTypes.set("map-style",b);map.setMapTypeId("map-style");mjpathslayer=new google.maps.FusionTablesLayer(mj_paths,{suppressInfoWindows:!0,clickable:!1});mjpathslayer.setQuery("SELECT 'geometry' FROM "+
mj_paths);!0==document.getElementById("mjCheck").checked&&mjpathslayer.setMap(map);google.maps.event.addListener(map,"center_changed",function(){var b=map.getCenter();centerLat=b.lat();centerLong=b.lng();changeHash()});google.maps.event.addListener(map,"zoom_changed",function(){currentZoom=map.getZoom();scaleFactor=6<=currentZoom?1:0.5;4>=currentZoom&&(scaleFactor=0.3);changeHash()});poppypathslayer=new google.maps.FusionTablesLayer(poppy_paths,{suppressInfoWindows:!0,clickable:!1});poppypathslayer.setQuery("SELECT 'geometry' FROM "+
poppy_paths);!0==document.getElementById("poppyCheck").checked&&poppypathslayer.setMap(map);methpathslayer=new google.maps.FusionTablesLayer(meth_paths,{suppressInfoWindows:!0,clickable:!1});methpathslayer.setQuery("SELECT 'geometry' FROM "+meth_paths);!0==document.getElementById("methCheck").checked&&methpathslayer.setMap(map);null!=parameters.mariguana&&((mjVisible="true"==parameters.mariguana)?$("#mjCheck").prop("checked",!0):$("#mjCheck").prop("checked",!1));null!=parameters.poppy&&(poppyVisible=
"true"==parameters.poppy)&&$("#poppyCheck").prop("checked",!0);null!=parameters.meth&&(methVisible="true"==parameters.meth)&&$("#methCheck").prop("checked",!0);null!=parameters.cocaine&&(cocaineVisible="true"==parameters.cocaine)&&$("#cocaineCheck").prop("checked",!0);var c=new google.maps.drawing.DrawingManager({drawingControl:!0,drawingControlOptions:{position:google.maps.ControlPosition.TOP_LEFT,drawingModes:[google.maps.drawing.OverlayType.POLYGON]},polygonOptions:{fillColor:"#0099FF",fillOpacity:0.7,
strokeColor:"#AA2143",strokeWeight:2,clickable:!0,zIndex:1,editable:!0}});c.setMap(map);google.maps.event.addListener(c,"drawingmode_changed",function(){!1==lastModePoly?deleteSelectedShape():lastModePoly=!lastModePoly});google.maps.event.addListener(c,"overlaycomplete",function(b){newShape=b.overlay;newShape.type=b.type;google.maps.event.addListener(newShape,"click",function(){setSelection(this)});setSelection(newShape);currentCity="Polygon";queryHomicideMonth();newShape.setEditable(!1);lastModePoly=
!0;changeHash();c.setDrawingMode(null)});null!=myPolygon&&myPolygon.setMap(map);$("#mediumSelect").change(function(){typeOfHomicide="INEGI"===typeOfHomicide?"DWRH":"INEGI";queryData();changeHash()});overlay=new Canvas(crimes,map);queryData();queryHomicideMonth()}
function initializeParameters(){parameters=$.deparam(document.location.hash);if(null!=parameters.year)yearSlider=parameters.year,changed=!0;$(function(){$("#slider").slider({min:2004,max:2010,value:yearSlider,stop:function(b,a){yearSlider=a.value;queryData();changeHash()},slide:function(b,a){document.getElementById("slider").firstChild.innerHTML=a.value}})});null!=parameters["#city"]&&(currentCity=parameters["#city"],changed=!0);if(null!=parameters.zoom)currentZoom=parameters.zoom,scaleFactor=6<=
currentZoom?1:0.5,4>=currentZoom&&(scaleFactor=0.3);null!=parameters.clat&&(centerLat=parameters.clat);null!=parameters.clong&&(centerLong=parameters.clong);if(null!=parameters.homtype)typeOfHomicide=parameters.homtype,$("#mediumSelect").val(typeOfHomicide);if(null!=parameters.polygon){polyString=parameters.polygon;for(var b=polyString.split(","),c=0;c<b.length;c++)coords.push(new google.maps.LatLng(Number(b[c].split(" ")[1]),Number(b[c].split(" ")[0])));myPolygon=new google.maps.Polygon({paths:coords,
strokeColor:"#AA2143",strokeOpacity:1,strokeWeight:2,fillColor:"#0099FF",fillOpacity:0.7})}}
var interHom=-1,interDRH=-1,interDRH2=-1,monthName="Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec".split(","),activeLine=!1,activeChart,start=new Date(2004,0,1),end=new Date(2010,11,30),data=pv.range(0,84,1).map(function(b){return{x:new Date(datehom[b]),y:homrate[b],z:drhrate[b],homtot:homtot[b],drhtot:drhtot[b]}}),w=370,h=180,x=pv.Scale.linear(start,end).range(0,w),y=pv.Scale.linear(0,pv.max(homrate.concat(drhrate))).range(0,h);
function createGraph(){function b(){return data=pv.range(35,84,1).map(function(a){return{x:new Date(datehom[a]),y:homrate[a],z:drhrate[a],homtot:homtot[a],drhtot:drhtot[a]}})}visChart=(new pv.Panel).width(w).height(h).bottom(20).left(40).top(17).fillStyle("#dedede");visChart.add(pv.Rule).data(x.ticks()).left(x).strokeStyle(function(a){return a?"#fff":"000"}).add(pv.Rule).bottom(-5).height(5).strokeStyle("#000").anchor("bottom").add(pv.Label).bottom(6).text(x.tickFormat);visChart.add(pv.Rule).data(function(){return y.ticks(3)}).bottom(y).strokeStyle(function(a){return a?
"#fff":"000"}).anchor("left").add(pv.Rule).left(-4).height(1).strokeStyle("#000").anchor("left").add(pv.Label).left(-1).text(y.tickFormat);visChart.add(pv.Rule).left(0);visChart.add(pv.Rule).bottom(0);visChart.add(pv.Label).data(["annual rate per 100,000"]).left(-27).bottom(h/2).font("10pt Arial").textAlign("center").textAngle(-Math.PI/2);visChart.add(pv.Rule).data(function(){return gethomicideData()}).left(function(a){return x(a.x)}).bottom(-4).lineWidth(5).strokeStyle(function(){return activeChart==
this.index?"#efefef":"transparent"});var c=visChart.add(pv.Line).data(function(){return gethomicideData()}).bottom(function(a){return y(a.y)}).left(function(a){return x(a.x)}).lineWidth(2.5).antialias(!0).strokeStyle("#004b62").text(y.tickFormat).text(function(a){return y(a)}).visible(function(a){return null==a.y?!1:!0}),d=visChart.add(pv.Line).data(function(){return b()}).bottom(function(a){return y(a.z)}).event("point",function(){this.active(this.index);return visChart}).left(function(a){return x(a.x)}).visible(function(a){return a.x>
new Date(2004,1,1)&&a.x<new Date(2006,11,1)?!1:!0}).lineWidth(2.5).antialias(!0).strokeStyle("#4eb4da");c.add(pv.Dot).visible(function(){return 0<=interDRH2}).data(function(){return[gethomicideData()[interDRH2]]}).fillStyle(function(){return c.strokeStyle()}).strokeStyle("#000").size(20).lineWidth(1).add(pv.Dot).left(10).top(10).anchor("right").add(pv.Label).textStyle("#222").text(function(a){if(null!=a.y)return monthName[a.x.getMonth()]+" "+a.x.getFullYear()+" rate: "+a.y.toFixed(0)+" ("+a.homtot+
" Total Homicides)"});d.add(pv.Dot).visible(function(){return 0<=interDRH}).data(function(){return[gethomicideData()[interDRH]]}).fillStyle(function(){return d.strokeStyle()}).strokeStyle("#000").size(20).lineWidth(1).add(pv.Dot).left(10).top(25).anchor("right").add(pv.Label).textStyle("#222").text(function(a){if(null!=a.z)return monthName[a.x.getMonth()]+" "+a.x.getFullYear()+" rate: "+a.z.toFixed(0)+" ("+a.drhtot+" DW-R Homicides)"});visChart.add(pv.Bar).fillStyle("rgba(0,0,0,.001)").event("mouseout",
function(){interDRH2=interDRH=-1;return visChart}).event("mousemove",function(){var a=x.invert(visChart.mouse().x),a=new Date(a.getFullYear(),a.getMonth(),15);interDRH=pv.search(gethomicideData().map(function(a){return a.x}),a);interDRH2=interDRH=0>interDRH?-interDRH-2:interDRH;2006>a.getFullYear()|2006>=a.getFullYear()&11>a.getMonth()&&(interDRH=-1);2010<a.getFullYear()&&(interDRH2=-1);return visChart});visChart.add(pv.Label).textAlign("left").text(function(){return"Total Homicides"}).left(15).top(-4).font("9pt sans-serif").add(pv.Dot).strokeStyle(null).height(3).fillStyle("#004b62").size(15).left(10).top(-11).add(pv.Label).def("active",
-1).textAlign("left").text(function(){return"Drug War-Related Homicides"}).left(125).top(-4).font("9pt sans-serif").add(pv.Dot).strokeStyle(null).fillStyle("#4eb4da").size(15).left(120).top(-11);op_marlin=new Date("July 7, 2007");getEvents=function(){var a=[];0<=currentCity.indexOf("Ju\u00e1rez")&&(a=[getIndex(new Date(2008,2,28)),getIndex(new Date(2009,2,28))],tip=["Joint Operation","Reinforcements sent to Ciudad Ju\u00e1rez"]);0<=currentCity.indexOf("Chihuahua")&&(a=[getIndex(new Date(2008,2,28))],
tip=["Joint Operation"]);0<=currentCity.indexOf("Nogales, ")&&(a=[getIndex(new Date(2008,0,16))],tip=["Capture of 'El Mochomo'"]);0<=currentCity.indexOf(", Michoac\u00e1n")&&(a=[getIndex(new Date(2006,11,12)),getIndex(new Date(2009,7,28))],tip=["Joint Operation Michoac\u00e1n","Joint Operation Michoac\u00e1n"]);if(0<=currentCity.indexOf("Culiac\u00e1n")||0<=currentCity.indexOf("Navolato"))a=[getIndex(op_marlin),getIndex(new Date(2008,2,28))],tip=["Operation Marlin","Joint Operation Culiac\u00e1n-Navolato"];
if(0<=currentCity.indexOf("Mazatl\u00e1n")||0<=currentCity.indexOf("Salvador Alvarado"))a=[getIndex(new Date(2008,5,28))],tip=["Joint Operation Culiac\u00e1n-Navolato-Mazatl\u00e1n-Salvador Alvarado"];"Nuevo Laredo"==currentCity&&(a=[9,17,getIndex(new Date(2010,1,23))],tip=["Expiration of the assault weapon ban","Operation Mexico Secure","Zetas vs CDG"]);"Monterrey"==currentCity&&(a=[getIndex(new Date(2004,9,14)),getIndex(new Date(2007,1,26)),getIndex(new Date(2010,1,23))],tip=["Expiration of the assault weapon ban",
"Operation Nuevo Le\u00f3n-Tamaulipas","Zetas vs CDG"]);"La Laguna"==currentCity&&(a=[getIndex(new Date(2007,7,23)),getIndex(new Date(2010,1,23))],tip=["Joint Operation La Laguna","Zetas vs CDG"]);"Tijuana"==currentCity&&(a=[getIndex(new Date(2007,1,23)),getIndex(new Date(2008,9,28))],tip=["Joint Operation Tijuana","Jail Riots started by<br/> the brother of 'El Muletas'"]);"Acapulco"==currentCity&&(a=[getIndex(new Date(2007,0,15)),getIndex(new Date(2010,7,28))],tip=["Joint Operation Guerrero","Capture of 'La Barbie'"]);
if(0<=currentCity.indexOf("Tamaulipas")||0<=currentCity.indexOf("Nuevo Le\u00f3n")||0<=currentCity.indexOf("Tampico")||0<=currentCity.indexOf("Reynosa")||0<=currentCity.indexOf("Matamoros")||0<=currentCity.indexOf("Ciudad Valles"))a=[getIndex(new Date(2010,1,23))],tip=["Zetas vs CDG"];if(0<=currentCity.indexOf("Jalisco")||0<=currentCity.indexOf("Nayarit")||0<=currentCity.indexOf("Colima")||0<=currentCity.indexOf("Tepic")||0<=currentCity.indexOf("Guadalajara")||0<=currentCity.indexOf("Colima-Villa de Alvarez")||
0<=currentCity.indexOf("Tecom\u00e1n")||0<=currentCity.indexOf("Puerto Vallarta"))a=[getIndex(new Date(2008,0,28)),getIndex(new Date(2010,3,6))],tip=["Capture of 'El Mochomo'","Kidnapping of Nacho Coronel's son"];0<=currentCity.indexOf("Cuernavaca")&&(a=[getIndex(new Date(2008,0,28)),getIndex(new Date(2009,11,20))],tip=["Capture of 'El Mochomo'","Arturo Beltr\u00e1n Leyva Killed"]);0<=currentCity.indexOf(", Guerrero")&&(a=[getIndex(new Date(2008,0,28))],tip=["Capture of 'El Mochomo'"]);return data=
a.map(function(a){return{x:new Date(datehom[a]),y:pv.max([homrate[a],drhrate[a]]),max:pv.max(homrate.slice(0>a-12?0:a-12,a+3).concat(drhrate.slice(0>a-12?0:a-12,a+3)))}})};visChart.add(pv.Dot).data(function(){return getEvents()}).bottom(function(a){return y(a.y)}).left(function(a){return x(a.x)}).size(10).lineWidth(1).antialias(!0).fillStyle("white").strokeStyle("black");visChart.add(pv.Dot).data(function(){return getEvents()}).bottom(function(a){return y(a.max)+70>h?180:y(a.max)+70}).left(function(a){return x(a.x)}).fillStyle("black").strokeStyle(null).event("mouseover",
function(){pv.Behavior.tipsy("disable").apply(this,arguments);pv.Behavior.tipsy({gravity:"e",fade:!0,html:!0}).apply(this,arguments);activeLine=!0;return visChart}).event("mouseout",function(){activeLine=!1;return visChart}).textAlign("right").text(function(){return tip[this.index]});visChart.add(pv.Rule).data(function(){return getEvents()}).left(function(a){return x(a.x)}).top(function(a){return y(a.max)+70>h?4:h+4-(y(a.max)+70)}).bottom(function(a){return y(a.y)+4}).strokeStyle("#666").textAlign("right").text(function(){return tip[this.index]})}
function gethomicideData(){return data=pv.range(0,84,1).map(function(b){return{x:new Date(datehom[b]),y:homrate[b],z:drhrate[b],homtot:homtot[b],drhtot:drhtot[b]}})}function rerenderGraph(){$('div[style^="position: absolute; width: 9px;"]').remove();null==visChart&&createGraph();y.domain(0,pv.max(homrate.concat(drhrate))).nice();visChart.render()}function getIndex(b){b=new Date(b);return 12*(b.getYear()-104)+b.getMonth()};
